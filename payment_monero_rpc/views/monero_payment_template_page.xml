<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Main payment page template (server-side rendered) -->
    <template id="monero_payment_page" name="Monero Payment Page" inherit_id="website.layout" page="True">
        <t t-call="website.layout">
            <t t-set="head">
                <script src="payment/static/src/js/payment_wizard_copy_clipboard_field.js"></script>
            </t>
            
            <div id="monero_payment_wrapper" class="container mt-4 mb-5">
                <!-- Dark Mode Toggle -->
<!--                <div class="float-right">
                    <button class="btn btn-sm btn-secondary toggle-dark">
                        <i class="fa fa-adjust"/> <span>Dark Mode</span>
                    </button>
                </div>
-->
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <!-- Payment Status Header -->
                        <div class="text-center mb-4">
                            <h1>Monero Payment</h1>
                            <t t-if="state == 'pending'">
                                <div class="alert alert-info">
                                    <i class="fa fa-clock-o mr-2"/>
                                    <span>Waiting for payment - expires in </span>
                                    <span t-esc="payment.expiry_time_str"/>
                                </div>
                            </t>
                            <t t-if="state == 'paid_unconfirmed'">
                                <div class="alert alert-warning">
                                    <i class="fa fa-check-circle mr-2"/>
                                    <span>Payment received - waiting for confirmations (</span>
                                    <span t-esc="payment.confirmations"/>/
                                    <span t-esc="payment.required_confirmations"/>)
                                </div>
                            </t>
                            <t t-if="state == 'confirmed'">
                                <div class="alert alert-success">
                                    <i class="fa fa-check-circle mr-2"/>
                                    <span>Payment confirmed! Thank you.</span>
                                </div>
                            </t>
                        </div>

                        <!-- Payment Details Card -->
                        <div class="card">
                            <div class="card-header">
                                <h4 class="mb-0">Payment Details</h4>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- QR Code -->
                                        <div class="text-center mb-4">
                                            <img t-att-src="'/payment/monero/qr/%s' % id" 
                                                 class="img-fluid" 
                                                 style="max-width: 250px;"
                                                 alt="Monero Payment QR Code"/>
                                            <p class="text-muted mt-2">Scan to pay with Monero wallet</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <!-- Payment Information -->
                                        <dl class="row">
                                            <dt class="col-sm-5">Order Reference:</dt>
                                            <dd class="col-sm-7" t-esc="payment.order_ref"/>

                                            <dt class="col-sm-5">Amount to Pay:</dt>
                                            <dd class="col-sm-7">
                                                <span t-esc="payment.amount_str"/> XMR
                                                <small class="text-muted d-block">
                                                    (â‰ˆ <span t-esc="payment.original_amount_str"/> 
                                                    <span t-esc="payment.original_currency"/>)
                                                </small>
                                            </dd>

                                            <dt class="col-sm-5">Exchange Rate:</dt>
                                            <dd class="col-sm-7">
                                                1 XMR = <span t-esc="payment.exchange_rate_str"/> 
                                                <span t-esc="payment.original_currency"/>
                                            </dd>

                                            <dt class="col-sm-5">Payment Address:</dt>
                                            <dd class="col-sm-7">
                                                <code t-esc="payment.address"/>
                                                <button class="btn btn-sm btn-link copy-btn" 
                                                        t-att-data-clipboard-text="address"
                                                        title="Copy to clipboard">
                                                    <i class="fa fa-copy"/>
                                                </button>
                                            </dd>

                                            <dt class="col-sm-5">Payment ID:</dt>
                                            <dd class="col-sm-7">
                                                <code t-esc="payment.payment_id"/>
                                            </dd>
                                        </dl>
                                    </div>
                                </div>

                                <!-- Payment Instructions -->
                                <div class="alert alert-light mt-4">
                                    <h5 class="alert-heading">How to pay:</h5>
                                    <ol>
                                        <li>Open your Monero wallet</li>
                                        <li>
                                            Send <strong><span t-esc="payment.amount_str"/> XMR</strong> 
                                            to the address above
                                        </li>
                                        <li>Wait for transaction confirmations (typically 10-20 minutes)</li>
                                    </ol>
                                    <p class="mb-0">
                                        <small class="text-muted">For help, please contact our support team.</small>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="text-center mt-3">
                            <a t-att-href="'/shop/order/%s' % sale_order_id" 
                               class="btn btn-outline-secondary mr-2">Back to Order</a>
                            <a t-att-href="'/payment/monero/invoice/%s' % id" 
                               class="btn btn-outline-primary">Download Invoice</a>
                            <t t-if="state == 'confirmed'">
                                <a t-att-href="'/payment/monero/proof/%s' % id" 
                                   class="btn btn-outline-success ml-2">Payment Proof</a>
                            </t>
                        </div>
                    </div>
                </div>
            </div>

            <!-- JavaScript Section -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Initialize clipboard.js
                    new ClipboardJS('.copy-btn').on('success', function(e) {
                        var btn = e.trigger;
                        btn.setAttribute('title', 'Copied!');
                        btn.querySelector('i').className = 'fa fa-check';
                        setTimeout(function() {
                            btn.setAttribute('title', 'Copy to clipboard');
                            btn.querySelector('i').className = 'fa fa-copy';
                        }, 2000);
                    });
                    
                    // Auto-refresh logic for pending payments
                    <t t-if="state in ['pending', 'paid_unconfirmed']">
                        var checkStatus = function() {
                            fetch('/payment/monero/status/<t t-esc="payment.id"/>')
                                .then(response => response.json())
                                .then(data => {
                                    if (data.error) {
                                        console.error(data.error);
                                        return;
                                    }
                                    if (data.status === 'confirmed') {
                                        window.location.reload();
                                    } else if (data.status === 'paid_unconfirmed') {
                                        document.querySelector('.alert-warning span').textContent = data.confirmations;
                                        setTimeout(checkStatus, 30000);
                                    } else if (data.status === 'pending') {
                                        setTimeout(checkStatus, 60000);
                                    }
                                })
                                .catch(error => console.error('Error:', error));
                        };
                        setTimeout(checkStatus, 60000);
                    </t>

                    // Dark mode toggle
                    document.querySelector('.toggle-dark').addEventListener('click', function() {
                        fetch('/website/switch_theme_mode', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                            }
                        }).then(() => window.location.reload());
                    });
                });
            </script>
        </t>
    </template>

    <!-- Simple version for client-side rendering -->
    <template id="monero_payment_component" name="Monero Payment Component" owl="1">
        <div class="monero-payment-component">
            <div class="alert alert-info" t-if="props.state === 'pending'">
                <i class="fa fa-clock-o mr-2"/>
                <span>Pending Monero Payment</span>
            </div>
            <div class="payment-details">
                <p>Amount: <strong t-esc="payment.props.amount_str"/> XMR</p>
                <p>Address: <code t-esc="payment.props.address"/></p>
                <button class="btn btn-primary check-status-btn">
                    Check Payment Status
                </button>
            </div>
        </div>
    </template>
</odoo>
